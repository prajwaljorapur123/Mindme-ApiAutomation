image: maven:3.9.2

pipelines:
  default:
    - step:
        name: Build and Test
        caches:
          - maven
        script:
          - mvn clean install --file Automation_Scripts/pom.xml || echo "Build failed" > build_status.txt
          - BUILD_STATUS=$?
          - if [ $BUILD_STATUS -eq 0 ]; then echo "Build succeeded"; else echo "Build failed"; fi
        after-script:
          - pipe: atlassian/checkstyle-report:0.3.0
    - step:
        name: Create Jira Ticket on Failure
        script:
          - >
            if [ -f build_status.txt ]; then
              JIRA_BASE_URL="${JIRA_BASE_URL}"
              JIRA_USER_EMAIL="${JIRA_USER_EMAIL}"
              JIRA_API_TOKEN="${JIRA_API_TOKEN}"
              JIRA_PROJECT="YOUR_PROJECT_KEY"
              JIRA_ISSUE_SUMMARY="Build Failure: $(date +'%Y-%m-%d %H:%M:%S')"
              JIRA_ISSUE_DESCRIPTION="The Bitbucket pipeline for the Maven project has failed. Please investigate the issue."
              pipe: atlassian/jira-create-issue:0.7.0
              variables:
                JIRA_BASE_URL: $JIRA_BASE_URL
                JIRA_USER_EMAIL: $JIRA_USER_EMAIL
                JIRA_API_TOKEN: $JIRA_API_TOKEN
                JIRA_PROJECT: $JIRA_PROJECT
                JIRA_ISSUE_TYPE: "Bug"
                JIRA_ISSUE_SUMMARY: $JIRA_ISSUE_SUMMARY
                JIRA_ISSUE_DESCRIPTION: $JIRA_ISSUE_DESCRIPTION
            else
              echo "Build succeeded, no Jira ticket created."
    - step:
        name: Security Scan
        script:
          - pipe: atlassian/git-secrets-scan:0.5.1
